name: ğŸ“¦ Build iStoreOS Firmware

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "å‘å¸ƒæ ‡ç­¾ï¼ˆå¦‚ 20250725ï¼‰"
        required: true
      packages:
        description: "è‡ªå®šä¹‰è½¯ä»¶åŒ…åï¼ˆç©ºæ ¼åˆ†éš”ï¼‰"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: âš™ï¸ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev zstd curl unzip

    - name: â¬ ä¸‹è½½ ImageBuilder
      run: |
        curl -L -o imagebuilder.tar.zst https://github.com/wukongdaily/istoreos-builder/releases/download/${{ github.event.inputs.tag }}/istoreos-imagebuilder-x86-64.Linux-x86_64.tar.zst
        tar --use-compress-program=unzstd -xvf imagebuilder.tar.zst
        mv istoreos-imagebuilder-* imagebuilder

    - name: ğŸ§± æ„å»ºå›ºä»¶
      working-directory: ./imagebuilder
      run: |
        make image \
          PACKAGES="${{ github.event.inputs.packages }}" \

    - name: ğŸ“¦ æ‰“åŒ…å›ºä»¶
      run: |
        mkdir -p output
        cp -r imagebuilder/bin/targets/*/* output/

    - name: ğŸš€ ä¸Šä¼ åˆ° Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.tag }}
        files: output/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
